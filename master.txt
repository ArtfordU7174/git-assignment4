Master code

This changes to the code was carried in private branch
